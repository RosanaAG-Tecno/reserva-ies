<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>IES La Fresneda · Reservas de aulas</title>
<script src="https://cdn.tailwindcss.com"></script>
<meta name="description" content="Reservas de Aula del Futuro, Radio y Biblioteca — IES La Fresneda (Asturias)"/>
<style>
  .tooltip{position:relative}.tooltip:hover .tooltiptext{visibility:visible;opacity:1}
  .tooltiptext{visibility:hidden;opacity:0;transition:opacity .15s ease;position:absolute;z-index:20;bottom:125%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:.25rem .5rem;border-radius:.375rem;white-space:nowrap;font-size:.75rem;pointer-events:none}
  .tw-safelist{display:none}
</style>
</head>
<body class="min-h-screen bg-gradient-to-b from-lime-50 via-emerald-50 to-sky-50 text-slate-800">
<div class="tw-safelist hidden bg-emerald-100 text-emerald-900 border-emerald-200 bg-emerald-500 text-emerald-700 bg-indigo-100 text-indigo-900 border-indigo-200 bg-indigo-500 text-indigo-700 bg-amber-100 text-amber-900 border-amber-200 bg-amber-500 text-amber-700 bg-orange-100 text-orange-900 border-orange-200 bg-orange-500 text-orange-700 bg-lime-100 text-lime-900 border-lime-200 bg-lime-500 text-lime-700 bg-teal-100 text-teal-900 border-teal-200 bg-teal-500 text-teal-700 bg-sky-100 text-sky-900 border-sky-200 bg-sky-500 text-sky-700 bg-violet-100 text-violet-900 border-violet-200 bg-violet-500 text-violet-700 bg-rose-100 text-rose-900 border-rose-200 bg-rose-500 text-rose-700 bg-cyan-100 text-cyan-900 border-cyan-200 bg-cyan-500 text-cyan-700 bg-fuchsia-100 text-fuchsia-900 border-fuchsia-200 bg-fuchsia-500 text-fuchsia-700"></div>

<header class="bg-white/80 backdrop-blur border-b border-slate-200 sticky top-0 z-30">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center gap-4">
    <img id="iesLogo" alt="IES La Fresneda" class="h-10 w-auto"
      src='data:image/svg+xml;utf8,<?xml version="1.0" encoding="UTF-8"?><svg xmlns="http://www.w3.org/2000/svg" width="320" height="64" viewBox="0 0 320 64"><defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="%23facc15"/><stop offset="1" stop-color="%23f97316"/></linearGradient><linearGradient id="g2" x1="0" x2="1"><stop offset="0" stop-color="%23a3e635"/><stop offset="1" stop-color="%2310b981"/></linearGradient></defs><g transform="translate(8,8)"><circle cx="16" cy="24" r="8" fill="%23facc15"/><path d="M32 24a16 16 0 1 1-16-16" fill="none" stroke="url(%23g2)" stroke-width="8" stroke-linecap="round"/><path d="M28 8a16 16 0 0 1 0 32" fill="none" stroke="url(%23g1)" stroke-width="8" stroke-linecap="round"/></g><text x="80" y="24" font-family="Inter,Arial,sans-serif" font-weight="700" font-size="20" fill="%23f59e0b">IES</text><text x="120" y="24" font-family="Inter,Arial,sans-serif" font-weight="700" font-size="20" fill="%2310b981">LA FRESNEDA</text></svg>' />
    <div class="flex-1">
      <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">IES de la Fresneda · Reservas de aulas</h1>
      <p class="text-sm text-slate-500">Aula del Futuro · Radio · Biblioteca — Asturias</p>
    </div>
    <div class="flex items-center gap-2">
      <button id="btnChangeLogo" class="px-3 py-2 rounded-xl bg-sky-100 text-sky-800 text-sm hover:bg-sky-200">Cambiar logo</button>
      <button id="btnExport" class="hidden sm:inline-flex items-center px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm hover:bg-emerald-700 shadow">Exportar JSON</button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 grid lg:grid-cols-3 gap-6">
  <section class="lg:col-span-1">
    <div class="bg-white shadow-sm rounded-2xl p-5 border border-slate-200">
      <h2 class="text-lg font-semibold mb-4">Crear reserva</h2>
      <form id="bookingForm" class="space-y-4" autocomplete="off">
        <div>
          <label class="block text-sm font-medium mb-1" for="teacher">Profesor/a</label>
          <input id="teacher" type="text" required placeholder="Nombre y apellidos" class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="subject">Materia</label>
          <input id="subject" type="text" required placeholder="Ej.: Tecnología" class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          <p class="text-xs text-slate-500 mt-1">Cada materia tendrá un color automático.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="pin">PIN (opcional)</label>
          <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="Ej.: 1234" class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          <p class="text-xs text-slate-500 mt-1">Si estableces un PIN, solo quien lo conozca podrá eliminar la reserva.</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1" for="room">Aula</label>
          <select id="room" class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500">
            <option value="Aula del Futuro">Aula del Futuro</option>
            <option value="Radio">Radio</option>
            <option value="Biblioteca">Biblioteca</option>
          </select>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1" for="startDate">Desde</label>
            <input id="startDate" type="date" required class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="endDate">Hasta</label>
            <input id="endDate" type="date" required class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="startTime">Hora inicio</label>
            <input id="startTime" type="time" class="w-full rounded-xl border-slate-300 bg-slate-50" readonly disabled/>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1" for="endTime">Hora fin</label>
            <input id="endTime" type="time" class="w-full rounded-xl border-slate-300 bg-slate-50" readonly disabled/>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1" for="slotSelect">Franja horaria</label>
          <select id="slotSelect" class="w-full rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500">
            <option value="0">08:15–09:10</option>
            <option value="1">09:10–10:05</option>
            <option value="2">10:25–11:20</option>
            <option value="3">11:20–12:15</option>
            <option value="4">12:35–13:30</option>
            <option value="5">13:30–14:25</option>
          </select>
          <p class="text-xs text-slate-500 mt-1">Reservas limitadas a las franjas oficiales.</p>
        </div>

        <fieldset class="border border-slate-200 rounded-xl p-3 bg-emerald-50/30">
          <legend class="px-2 text-sm text-slate-600">Repetir por días</legend>
          <div class="grid grid-cols-3 gap-2 text-sm">
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="1" class="dw" checked> L</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="2" class="dw" checked> M</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="3" class="dw" checked> X</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="4" class="dw" checked> J</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="5" class="dw" checked> V</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="6" class="dw"> S</label>
            <label class="inline-flex items-center gap-2"><input type="checkbox" value="0" class="dw"> D</label>
          </div>
        </fieldset>

        <div class="flex items-center justify-between gap-3">
          <button type="submit" class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-emerald-600 text-white font-medium hover:bg-emerald-700 shadow">Guardar</button>
          <button type="button" id="clearBtn" class="text-sm text-slate-600 hover:text-slate-900">Borrar todo</button>
        </div>
        <p id="formMsg" class="text-sm"></p>
      </form>
    </div>

    <div class="mt-6 bg-white shadow-sm rounded-2xl p-5 border border-slate-200">
      <h3 class="text-sm font-semibold text-slate-700 mb-2">Leyenda aulas</h3>
      <div class="flex flex-wrap gap-2 text-sm">
        <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-emerald-500"></span> Aula del Futuro</span>
        <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-indigo-500"></span> Radio</span>
        <span class="inline-flex items-center gap-2"><span class="w-3 h-3 rounded bg-amber-500"></span> Biblioteca</span>
      </div>
    </div>
  </section>

  <section class="lg:col-span-2">
    <div class="bg-white shadow-sm rounded-2xl p-4 border border-slate-200">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-2">
          <button id="prevBtn" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">←</button>
          <button id="todayBtn" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Hoy</button>
          <button id="nextBtn" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">→</button>
        </div>
        <h2 id="monthLabel" class="text-lg font-semibold"></h2>
        <div class="hidden sm:flex items-center gap-2">
          <button id="btnDay" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Día</button>
          <button id="btnWeek" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">Semana</button>
          <button id="btnMonth" class="px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Mes</button>
        </div>
      </div>

      <!-- Mes (L–V) -->
      <div id="monthView" class="hidden space-y-2">
        <div class="grid grid-cols-5 text-xs sm:text-sm font-medium text-slate-500">
          <div class="text-center">L</div><div class="text-center">M</div><div class="text-center">X</div><div class="text-center">J</div><div class="text-center">V</div>
        </div>
        <div id="calendarGrid" class="grid grid-cols-5 gap-2"></div>
      </div>

      <!-- Semana (por defecto) -->
      <div id="weekView">
        <div class="flex flex-wrap items-center gap-3 mb-3">
          <input type="date" id="weekPicker" class="rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          <select id="weekRoom" class="rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500">
            <option value="Aula del Futuro">Aula del Futuro</option>
            <option value="Radio">Radio</option>
            <option value="Biblioteca">Biblioteca</option>
          </select>
          <span id="weekLabel" class="text-slate-600"></span>
        </div>
        <div class="overflow-auto">
          <table class="min-w-full text-sm border border-slate-200 rounded-xl overflow-hidden">
            <thead class="bg-emerald-50">
              <tr>
                <th class="p-2 text-left border-b border-slate-200">Franja</th>
                <th class="p-2 border-b border-slate-200">L</th>
                <th class="p-2 border-b border-slate-200">M</th>
                <th class="p-2 border-b border-slate-200">X</th>
                <th class="p-2 border-b border-slate-200">J</th>
                <th class="p-2 border-b border-slate-200">V</th>
              </tr>
            </thead>
            <tbody id="weekBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Día -->
      <div id="dayView" class="hidden">
        <div class="flex items-center gap-3 mb-3">
          <input type="date" id="dayPicker" class="rounded-xl border-slate-300 focus:border-emerald-500 focus:ring-emerald-500"/>
          <span id="dayLabel" class="text-slate-600"></span>
        </div>
        <div id="dayList" class="space-y-2"></div>
      </div>
    </div>
  </section>
</main>

<dialog id="dayModal" class="rounded-2xl p-0 w-full max-w-xl backdrop:bg-black/30">
  <div class="bg-white rounded-2xl overflow-hidden">
    <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
      <h3 id="modalDate" class="font-semibold"></h3>
      <button class="px-3 py-1 rounded-xl bg-slate-100 hover:bg-slate-200" onclick="document.getElementById('dayModal').close()">Cerrar</button>
    </div>
    <div class="p-4" id="modalContent"></div>
  </div>
</dialog>

<footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-center text-xs text-slate-500">
  <p>Datos guardados en tu navegador (localStorage). Preparado para pestaña de Microsoft Teams (SharePoint/OneDrive).</p>
</footer>

<script>
window.addEventListener('DOMContentLoaded', function(){
  'use strict';

  // ---------- Utilidades LOCAL time (sin UTC) ----------
  function pad2(n){return n<10?'0'+n:''+n}
  function toISODateLocal(d){return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate())}
  function fromISODateLocal(s){var p=s.split('-').map(Number); return new Date(p[0],p[1]-1,p[2])}
  function startOfDay(d){return new Date(d.getFullYear(),d.getMonth(),d.getDate())}
  function mondayOf(d){var x=startOfDay(d); var s=(x.getDay()+6)%7; x.setDate(x.getDate()-s); return x}
  function addDays(d,n){var x=new Date(d); x.setDate(x.getDate()+n); return x}
  function sameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate()}
  function parseTime(t){var p=t.split(':'),h=+p[0]||0,m=+p[1]||0;return h*60+m}

  // ---------- Datos ----------
  var KEY='reservasAulas_v6';
  var rooms={ 'Aula del Futuro':{color:'emerald',badge:'AF'}, 'Radio':{color:'indigo',badge:'RD'}, 'Biblioteca':{color:'amber',badge:'BI'} };
  var months=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  var weekdays=['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'];
  var timeSlots=[{s:'08:15',e:'09:10',label:'08:15–09:10'},{s:'09:10',e:'10:05',label:'09:10–10:05'},{s:'10:25',e:'11:20',label:'10:25–11:20'},{s:'11:20',e:'12:15',label:'11:20–12:15'},{s:'12:35',e:'13:30',label:'12:35–13:30'},{s:'13:30',e:'14:25',label:'13:30–14:25'}];
  var palette=['emerald','orange','lime','teal','sky','violet','amber','rose','cyan','indigo','fuchsia'];
  function subjectColor(s){s=(s||'').toLowerCase(); var h=0; for(var i=0;i<s.length;i++){h=(h*31+s.charCodeAt(i))>>>0} return palette[h%palette.length]}

  function uid(){return 'r_'+Math.random().toString(36).slice(2,10)}
  function load(){try{return JSON.parse(localStorage.getItem(KEY))||[]}catch(e){return[]}}
  function save(list){try{localStorage.setItem(KEY,JSON.stringify(list))}catch(e){}}

  // ---------- Logo personalizable ----------
  (function(){
    var stored=localStorage.getItem('IES_LOGO_DATAURL');
    var img=document.getElementById('iesLogo');
    if(stored){ img.src=stored; }
    document.getElementById('btnChangeLogo').addEventListener('click', async function(){
      var v=prompt('Pega una URL de imagen (PNG/SVG) o un data URL (data:image/png;base64,...)');
      if(!v) return;
      try{
        if(v.startsWith('data:')){ localStorage.setItem('IES_LOGO_DATAURL',v); img.src=v; return; }
        const res=await fetch(v,{mode:'cors'}); const blob=await res.blob();
        const reader=new FileReader(); reader.onload=()=>{ localStorage.setItem('IES_LOGO_DATAURL',reader.result); img.src=reader.result; };
        reader.readAsDataURL(blob);
      }catch(e){ alert('No se pudo cargar el logo. Si el servidor bloquea CORS, pega un data:base64.'); }
    });
  })();

  // ---------- Vista Mes (L–V) ----------
  var grid=document.getElementById('calendarGrid'), label=document.getElementById('monthLabel');
  var current=new Date(); current=new Date(current.getFullYear(),current.getMonth(),1);

  function renderMonth(){
    grid.innerHTML='';
    var list=load(), y=current.getFullYear(), m=current.getMonth();
    label.textContent=months[m]+' '+y;

    var first=new Date(y,m,1);
    var firstMonday=mondayOf(first);

    // Pintamos 5 ó 6 filas de lunes a viernes
    for(var wk=0; wk<6; wk++){
      for(var d=0; d<5; d++){
        var date=addDays(firstMonday, wk*7 + d);
        // si no hay ningún día del mes en esta fila extra, salimos
        if(wk>4 && date.getMonth()!==m && addDays(date,-5).getMonth()!==m) continue;

        var iso=toISODateLocal(date);
        var inMonth=date.getMonth()===m;
        var today=startOfDay(new Date());

        var cell=document.createElement('div');
        cell.className='rounded-xl min-h-[120px] border p-2 flex flex-col gap-1 '+(inMonth?'bg-white border-slate-200':'bg-slate-50 border-slate-100 text-slate-400');

        var head=document.createElement('div'); head.className='flex items-center justify-between mb-1';
        var dn=document.createElement('div'); dn.className='text-sm font-semibold'; dn.textContent=date.getDate(); head.appendChild(dn);
        if(sameDay(date,today)){ var dot=document.createElement('span'); dot.className='inline-flex items-center justify-center text-[10px] font-semibold px-2 py-0.5 rounded-full bg-emerald-600 text-white'; dot.textContent='Hoy'; head.appendChild(dot); }
        cell.appendChild(head);

        var dayRes=list.filter(function(r){ return r.date===iso }).sort(function(a,b){return parseTime(a.startTime)-parseTime(b.startTime)});
        dayRes.slice(0,4).forEach(function(r){ cell.appendChild(makeChip(r,true)); });
        if(dayRes.length>4){ var more=document.createElement('div'); more.className='text-xs text-slate-500'; more.textContent='+'+(dayRes.length-4)+' más'; cell.appendChild(more); }

        cell.classList.add('cursor-pointer','hover:border-emerald-400');
        cell.addEventListener('click',(function(di){return function(){openDayModal(di)}})(iso));
        grid.appendChild(cell);
      }
    }
  }

  function makeChip(r,hideHours){
    var col=subjectColor(r.subject);
    var el=document.createElement('div');
    el.className='tooltip inline-flex items-center gap-2 text-[11px] px-2 py-1 rounded-lg bg-'+col+'-100 text-'+col+'-900 border border-'+col+'-200';
    var text=hideHours?(r.teacher+' · '+r.subject):(r.startTime+'–'+r.endTime+' · '+r.teacher+' · '+r.subject);
    el.innerHTML='<span class="inline-flex items-center justify-center w-5 h-5 rounded-md bg-'+col+'-500 text-white text-[10px]">'+(rooms[r.room]?rooms[r.room].badge:'?')+'</span> <span class="truncate">'+text+'</span>';
    var tt=document.createElement('span'); tt.className='tooltiptext'; tt.textContent=r.room+' · '+r.teacher+' ('+r.subject+') '+r.startTime+'–'+r.endTime; el.appendChild(tt);
    return el;
  }

  // ---------- Vista Semana (L–V) ----------
  var weekPicker=document.getElementById('weekPicker'), weekLabel=document.getElementById('weekLabel'), weekBody=document.getElementById('weekBody'), weekRoom=document.getElementById('weekRoom');

  function renderWeek(){
    // Base: lo que haya en el picker; si está vacío, hoy (local)
    var base = weekPicker.value ? fromISODateLocal(weekPicker.value) : startOfDay(new Date());
    var monday = mondayOf(base);
    weekPicker.value = toISODateLocal(monday);

    // sincronizo el título grande con el mes del lunes de la semana
    document.getElementById('monthLabel').textContent = months[monday.getMonth()] + ' ' + monday.getFullYear();

    var end = addDays(monday,4);
    weekLabel.textContent = 'Semana del '+ toISODateLocal(monday) +' al '+ toISODateLocal(end);

    weekBody.innerHTML='';
    var list=load(), roomSel=weekRoom.value;

    timeSlots.forEach(function(slot){
      var tr=document.createElement('tr');
      tr.innerHTML='<td class="p-2 border-b border-slate-200 font-medium bg-emerald-50">'+slot.label+'</td>';
      for(var i=0;i<5;i++){
        var day=addDays(monday,i); var iso=toISODateLocal(day);
        var td=document.createElement('td'); td.className='p-2 align-top border-b border-slate-200 min-w-[140px]';
        var matches=list.filter(function(r){return r.room===roomSel && r.date===iso && r.startTime===slot.s && r.endTime===slot.e})
                        .sort(function(a,b){return a.teacher.localeCompare(b.teacher)});
        if(!matches.length){ td.innerHTML='<div class="text-xs text-slate-400">— libre —</div>'; }
        else { matches.forEach(function(r){ td.appendChild(makeChip(r,true)); }); }
        tr.appendChild(td);
      }
      weekBody.appendChild(tr);
    });
  }

  // ---------- Vista Día ----------
  var dayView=document.getElementById('dayView'), monthView=document.getElementById('monthView'), weekView=document.getElementById('weekView');
  var btnDay=document.getElementById('btnDay'), btnWeek=document.getElementById('btnWeek'), btnMonth=document.getElementById('btnMonth');
  var dayPicker=document.getElementById('dayPicker'), dayLabel=document.getElementById('dayLabel');

  function renderDay(iso){
    var date = fromISODateLocal(iso);
    var list=load().filter(function(r){return r.date===iso}).sort(function(a,b){return parseTime(a.startTime)-parseTime(b.startTime)});
    var cont=document.getElementById('dayList'); cont.innerHTML='';
    dayLabel.textContent=['Dom','Lun','Mar','Mié','Jue','Vie','Sáb'][date.getDay()]+', '+iso;
    if(!list.length){ cont.innerHTML='<p class="text-slate-500">Sin reservas para este día.</p>'; return; }
    list.forEach(function(r){
      var col=subjectColor(r.subject);
      var row=document.createElement('div'); row.className='flex items-center justify-between gap-3 p-3 border border-slate-200 rounded-xl';
      row.innerHTML='<div class="flex items-center gap-3"><span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-'+col+'-500 text-white text-xs font-semibold">'+(rooms[r.room]?rooms[r.room].badge:'?')+'</span><div><div class="text-sm font-medium">'+r.startTime+'–'+r.endTime+' · '+r.room+'</div><div class="text-xs text-slate-600">'+r.teacher+' — '+r.subject+'</div></div></div>';
      var del=document.createElement('button'); del.className='px-3 py-1 rounded-lg text-sm bg-rose-600 text-white hover:bg-rose-700'; del.textContent='Eliminar';
      del.addEventListener('click',function(){ if(r.pin && prompt('PIN de esta reserva:')!==r.pin){alert('PIN incorrecto');return} var all=load(); save(all.filter(function(x){return x.id!==r.id})); renderMonth(); renderDay(iso); renderWeek(); });
      row.appendChild(del); cont.appendChild(row);
    });
  }

  // ---------- Modal Día desde Mes ----------
  var dayModal=document.getElementById('dayModal'), modalDate=document.getElementById('modalDate'), modalContent=document.getElementById('modalContent');
  function openDayModal(iso){
    var date = fromISODateLocal(iso);
    var list=load().filter(function(r){return r.date===iso}).sort(function(a,b){return parseTime(a.startTime)-parseTime(b.startTime)});
    modalDate.textContent=iso+' — '+['Domingo','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado'][date.getDay()];
    modalContent.innerHTML=list.length?'':'<p class="text-slate-500">No hay reservas para este día.</p>';
    list.forEach(function(r){
      var col=subjectColor(r.subject);
      var card=document.createElement('div'); card.className='flex items-center justify-between gap-3 p-3 border border-slate-200 rounded-xl';
      card.innerHTML='<div class="flex-1"><div class="text-sm font-medium">'+r.startTime+'–'+r.endTime+' · <span class="text-'+col+'-700">'+r.room+'</span></div><div class="text-xs text-slate-600">'+r.teacher+' — '+r.subject+'</div></div>';
      var del=document.createElement('button'); del.className='px-3 py-1 rounded-lg text-sm bg-rose-600 text-white hover:bg-rose-700'; del.textContent='Eliminar';
      del.addEventListener('click',function(){ if(r.pin && prompt('PIN de esta reserva:')!==r.pin){alert('PIN incorrecto');return} var all=load(); save(all.filter(function(x){return x.id!==r.id})); renderMonth(); renderWeek(); openDayModal(iso); });
      card.appendChild(del); modalContent.appendChild(card);
    });
    if(dayModal && dayModal.showModal){ dayModal.showModal(); }
  }

  // ---------- Navegación ----------
  function setActive(btn){ btnDay.className='px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200'; btnWeek.className='px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200'; btnMonth.className='px-3 py-2 rounded-xl bg-slate-100 hover:bg-slate-200'; btn.className='px-3 py-2 rounded-xl bg-emerald-600 text-white'; }
  btnDay.addEventListener('click',function(){ monthView.classList.add('hidden'); weekView.classList.add('hidden'); dayView.classList.remove('hidden'); setActive(btnDay); var iso=toISODateLocal(new Date()); dayPicker.value=iso; renderDay(iso); });
  btnWeek.addEventListener('click',function(){ monthView.classList.add('hidden'); dayView.classList.add('hidden'); weekView.classList.remove('hidden'); setActive(btnWeek); renderWeek(); });
  btnMonth.addEventListener('click',function(){ dayView.classList.add('hidden'); weekView.classList.add('hidden'); monthView.classList.remove('hidden'); setActive(btnMonth); renderMonth(); });

  document.getElementById('prevBtn').addEventListener('click',function(){
    if(!weekView.classList.contains('hidden')){
      var base=weekPicker.value?fromISODateLocal(weekPicker.value):startOfDay(new Date());
      base.setDate(base.getDate()-7); weekPicker.value=toISODateLocal(base); renderWeek();
    } else { current.setMonth(current.getMonth()-1); renderMonth(); }
  });
  document.getElementById('nextBtn').addEventListener('click',function(){
    if(!weekView.classList.contains('hidden')){
      var base=weekPicker.value?fromISODateLocal(weekPicker.value):startOfDay(new Date());
      base.setDate(base.getDate()+7); weekPicker.value=toISODateLocal(base); renderWeek();
    } else { current.setMonth(current.getMonth()+1); renderMonth(); }
  });
  document.getElementById('todayBtn').addEventListener('click',function(){
    if(!weekView.classList.contains('hidden')){
      var mon=mondayOf(startOfDay(new Date())); weekPicker.value=toISODateLocal(mon); renderWeek();
    } else { var t=new Date(); current=new Date(t.getFullYear(),t.getMonth(),1); renderMonth(); }
  });
  weekPicker.addEventListener('change',renderWeek);
  weekRoom.addEventListener('change',function(){ renderWeek(); }); // NO cambia la fecha
  if(dayPicker) dayPicker.addEventListener('change',function(e){ renderDay(e.target.value); });

  // ---------- Formulario ----------
  var form=document.getElementById('bookingForm'), msg=document.getElementById('formMsg'), slotSelect=document.getElementById('slotSelect');
  function applySlot(i){var s=timeSlots[i]; if(!s)return; document.getElementById('startTime').value=s.s; document.getElementById('endTime').value=s.e;}
  slotSelect.addEventListener('change',function(){applySlot(+slotSelect.value)});

  function hasConflict(list,c){ var cS=parseTime(c.startTime), cE=parseTime(c.endTime); return list.some(function(r){ return r.room===c.room && r.date===c.date && (Math.max(parseTime(r.startTime),cS) < Math.min(parseTime(r.endTime),cE)); }); }

  form.addEventListener('submit',function(e){
    e.preventDefault(); msg.textContent=''; msg.className='text-sm';
    var teacher=document.getElementById('teacher').value.trim();
    var subject=document.getElementById('subject').value.trim();
    var pin=(document.getElementById('pin')&&document.getElementById('pin').value)||'';
    var room=document.getElementById('room').value;
    var startDate=document.getElementById('startDate').value;
    var endDate=document.getElementById('endDate').value;
    var startTime=document.getElementById('startTime').value;
    var endTime=document.getElementById('endTime').value;
    var daysWanted=[].slice.call(document.querySelectorAll('.dw:checked')).map(function(x){return +x.value});

    if(!teacher||!subject){ msg.textContent='Introduce profesor/a y materia.'; msg.classList.add('text-rose-600'); return;}
    if(!startDate||!endDate){ msg.textContent='Completa fechas.'; msg.classList.add('text-rose-600'); return;}

    var s=fromISODateLocal(startDate), eD=fromISODateLocal(endDate);
    if(eD<s){ msg.textContent='La fecha "Hasta" debe ser posterior a "Desde".'; msg.classList.add('text-rose-600'); return;}

    var created=[], all=load();
    for(var d=new Date(s); d<=eD; d.setDate(d.getDate()+1)){
      var dw=d.getDay(); if(daysWanted.indexOf(dw)===-1) continue;
      var iso=toISODateLocal(d);
      var entry={id:uid(),teacher:teacher,subject:subject,room:room,date:iso,startTime:startTime,endTime:endTime,pin:pin};
      if(hasConflict(all.concat(created),entry)) created.push(Object.assign({},entry,{conflict:true})); else created.push(entry);
    }
    var ok=created.filter(function(x){return !x.conflict}), bad=created.filter(function(x){return x.conflict});
    save(all.concat(ok)); renderMonth(); renderWeek();

    if(ok.length && !bad.length){ msg.textContent='✔ Se guardaron '+ok.length+' reservas.'; msg.classList.add('text-emerald-700'); form.reset(); slotSelect.value='1'; applySlot(1);}
    else if(ok.length && bad.length){ msg.textContent='⚠ Guardadas '+ok.length+'; '+bad.length+' en conflicto no se añadieron.'; msg.classList.add('text-amber-700'); }
    else if(!ok.length && bad.length){ msg.textContent='❌ Todas las reservas entraban en conflicto.'; msg.classList.add('text-rose-700'); }
    else { msg.textContent='No se creó ninguna reserva.'; msg.classList.add('text-slate-600'); }
  });

  document.getElementById('clearBtn').addEventListener('click',function(){ if(confirm('¿Borrar TODAS las reservas?')){ save([]); renderMonth(); renderWeek(); }});
  document.getElementById('btnExport').addEventListener('click',function(){ var data=JSON.stringify(load(),null,2), blob=new Blob([data],{type:'application/json'}), a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='reservas_IES_Fresneda.json'; a.click(); });

  // ---------- Inicio ----------
  var todayISO=toISODateLocal(new Date());
  var sEl=document.getElementById('startDate'), eEl=document.getElementById('endDate'); if(sEl) sEl.value=todayISO; if(eEl) eEl.value=todayISO;
  document.getElementById('slotSelect').value='1'; applySlot(1);

  // Semana por defecto
  (function(){ var mon=mondayOf(startOfDay(new Date())); weekPicker.value=toISODateLocal(mon); renderWeek(); setActive(btnWeek); monthView.classList.add('hidden'); dayView.classList.add('hidden'); weekView.classList.remove('hidden'); })();
});
</script>
</body>
</html>


