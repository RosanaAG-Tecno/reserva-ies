<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IES La Fresneda · Reservas de aulas</title>
  <link rel="icon" href="data:," />
  <!-- Tailwind (CDN) para maquetado rápido -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Pastel agradable tipo IES */
    body { background: linear-gradient(180deg,#f2fff3 0%, #eef9ff 100%); }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 8px 20px rgba(0,0,0,.06); }
    .slot-cell { min-height: 76px; border-radius: 12px; border: 1px dashed #e5e7eb; background: #ffffffaa; }
    .slot-pill { display:inline-block; padding:.2rem .5rem; border-radius: 8px; font-size: .8rem; background:#e6fffb; }
    .week-head th { color:#334155; font-weight:600; }
    .label-muted { color:#6b7280; font-size:.8rem; }
  </style>
</head>
<body class="text-slate-800">

  <!-- Cabecera -->
  <header class="w-full max-w-6xl mx-auto px-4 py-4 flex items-center gap-4">
    <img src="https://raw.githubusercontent.com/rosanaag-tecno/reservas/main/IES%20La%20Fresneda.png" alt="IES La Fresneda" class="h-7" />
    <h1 class="text-xl sm:text-2xl font-semibold">IES La Fresneda · Reservas de aulas</h1>
    <div class="ml-auto flex items-center gap-2">
      <button id="btnPrev" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-50">←</button>
      <button id="btnToday" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-50">Hoy</button>
      <button id="btnNext" class="px-3 py-2 rounded-lg bg-white border hover:bg-slate-50">→</button>
      <span id="weekTitle" class="ml-2 text-sm label-muted"></span>
    </div>
  </header>

  <main class="w-full max-w-6xl mx-auto px-4 pb-16 grid grid-cols-1 lg:grid-cols-[360px,1fr] gap-6">
    <!-- Panel de creación -->
    <section class="card p-5">
      <h2 class="text-lg font-semibold mb-3">Crear reserva</h2>

      <label class="block text-sm mb-1">Profesor/a</label>
      <input id="iNombre" class="w-full mb-3 p-2.5 border rounded-lg" placeholder="Nombre y apellidos" />

      <label class="block text-sm mb-1">Materia</label>
      <input id="iMateria" class="w-full mb-3 p-2.5 border rounded-lg" placeholder="Ej.: Tecnología" />

      <label class="block text-sm mb-1">PIN (opcional para proteger la reserva)</label>
      <input id="iPin" class="w-full mb-3 p-2.5 border rounded-lg" placeholder="Ej.: 1234" />

      <label class="block text-sm mb-1">Aula</label>
      <select id="iAula" class="w-full mb-3 p-2.5 border rounded-lg">
        <option>Aula del Futuro</option>
        <option>Radio</option>
        <option>Biblioteca</option>
      </select>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm mb-1">Desde</label>
          <input type="date" id="iDesde" class="w-full p-2.5 border rounded-lg" />
        </div>
        <div>
          <label class="block text-sm mb-1">Hasta</label>
          <input type="date" id="iHasta" class="w-full p-2.5 border rounded-lg" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3 mt-3">
        <div>
          <label class="block text-sm mb-1">Franja horaria</label>
          <select id="iFranja" class="w-full p-2.5 border rounded-lg">
            <option>08:15–09:10</option>
            <option>09:10–10:05</option>
            <option>10:25–11:20</option>
            <option>11:20–12:15</option>
            <option>12:35–13:30</option>
            <option>13:30–14:25</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <p class="text-sm font-medium">Repetir por días</p>
        <div class="grid grid-cols-6 gap-3 mt-2 text-sm">
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="1" checked> L</label>
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="2"> M</label>
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="3" checked> X</label>
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="4"> J</label>
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="5" checked> V</label>
          <label class="inline-flex items-center gap-1"><input type="checkbox" class="dayChk" value="0"> D</label>
        </div>
      </div>

      <button id="btnGuardar" class="mt-5 w-full py-2.5 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white font-medium">
        Guardar
      </button>

      <p id="msg" class="mt-3 text-sm text-slate-600"></p>

      <div class="mt-6">
        <p class="text-sm font-medium mb-2">Leyenda (aulas)</p>
        <div class="flex items-center gap-4 text-sm">
          <span class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-emerald-500"></span> Aula del Futuro</span>
          <span class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-indigo-500"></span> Radio</span>
          <span class="inline-flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-full bg-cyan-500"></span> Biblioteca</span>
        </div>
      </div>
    </section>

    <!-- Calendario semanal -->
    <section class="card p-5 overflow-x-auto">
      <table class="w-full">
        <thead class="week-head">
          <tr>
            <th class="text-left p-2">Franja</th>
            <th class="text-center p-2">L</th>
            <th class="text-center p-2">M</th>
            <th class="text-center p-2">X</th>
            <th class="text-center p-2">J</th>
            <th class="text-center p-2">V</th>
          </tr>
        </thead>
        <tbody id="gridBody" class="align-top"></tbody>
      </table>
      <p class="mt-2 label-muted">Para borrar una reserva creada por ti, haz clic en su etiqueta e introduce tu PIN.</p>
    </section>
  </main>

  <!-- Firebase -->
  <script type="module">
    // Firebase SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // === TU CONFIGURACIÓN (ya la comprobaste) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCzoZJD3TZyK9eWGtLKKZsxdqtOwV51tY0",
      authDomain: "reservas-ies-fresneda.firebaseapp.com",
      projectId: "reservas-ies-fresneda",
      storageBucket: "reservas-ies-fresneda.firebasestorage.app",
      messagingSenderId: "536472576233",
      appId: "1:536472576233:web:4571c2f9de71c9ad0a1078"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    await signInAnonymously(auth);

    // ---------- Utilidades fecha ----------
    const FRANJAS = [
      "08:15–09:10",
      "09:10–10:05",
      "10:25–11:20",
      "11:20–12:15",
      "12:35–13:30",
      "13:30–14:25",
    ];

    const weekTitle = document.getElementById('weekTitle');
    let currentMonday = mondayOf(new Date());

    function mondayOf(d) {
      const dd = new Date(d); dd.setHours(0,0,0,0);
      const day = dd.getDay(); // 0..6 (0=Dom)
      const diff = (day === 0 ? -6 : 1 - day);
      dd.setDate(dd.getDate() + diff);
      return dd;
    }
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtISO(d) { return d.toISOString().slice(0,10); }
    function rangoSemanaTexto(d) {
      const f1 = addDays(d,0), f2 = addDays(d,6);
      const fmt = (x)=>x.toLocaleDateString('es-ES',{year:'numeric', month:'2-digit', day:'2-digit'});
      return `Semana del ${fmt(f1)} al ${fmt(f2)}`;
    }

    // ---------- UI ----------
    const gridBody = document.getElementById('gridBody');
    const btnPrev  = document.getElementById('btnPrev');
    const btnNext  = document.getElementById('btnNext');
    const btnToday = document.getElementById('btnToday');

    btnPrev.onclick  = ()=>{ currentMonday = addDays(currentMonday,-7); renderWeek(); };
    btnNext.onclick  = ()=>{ currentMonday = addDays(currentMonday, 7); renderWeek(); };
    btnToday.onclick = ()=>{ currentMonday = mondayOf(new Date()); renderWeek(); };

    // Crea matriz 6 franjas x 5 días
    function emptyMatrix() {
      const m = [];
      FRANJAS.forEach(()=> m.push([[],[],[],[],[]]));
      return m;
    }

    // Color estable por materia
    function colorFromString(s) {
      // hash simple
      let h = 0; for (let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5)-h);
      const hue = Math.abs(h)%360;
      return `hsl(${hue} 80% 88%)`;
    }

    async function renderWeek() {
      weekTitle.textContent = rangoSemanaTexto(currentMonday);
      // fechas ISO para L..V
      const fechas = [0,1,2,3,4].map(i => fmtISO(addDays(currentMonday, i)));

      // Limpia
      gridBody.innerHTML = '';
      const matrix = emptyMatrix();

      // Carga reservas (ID determinista aula_fecha_franja)
      // Vamos a probar existencias por IDs generados; para mostrar iteramos las combinaciones
      // Con un getDoc por cada celda (6*5=30) es suficiente y sencillo:
      for (let r=0;r<FRANJAS.length;r++) {
        for (let c=0;c<5;c++) {
          const id = idReserva(document.getElementById('iAula').value, fechas[c], FRANJAS[r]); // por aula actual
          const d = await getDoc(doc(db, 'reservas', id));
          if (d.exists()) matrix[r][c].push(d.data());
        }
      }

      // Construye filas
      for (let r=0;r<FRANJAS.length;r++) {
        const tr = document.createElement('tr');

        // Columna franja
        const tdLabel = document.createElement('td');
        tdLabel.className = 'p-2 align-top label-muted';
        tdLabel.innerHTML = `<div class="slot-pill">${FRANJAS[r]}</div>`;
        tr.appendChild(tdLabel);

        // 5 días
        for (let c=0;c<5;c++) {
          const td = document.createElement('td');
          td.className = 'p-2 align-top';
          const cell = document.createElement('div');
          cell.className = 'slot-cell p-2';
          const reservas = matrix[r][c];

          if (reservas.length===0) {
            cell.innerHTML = `<div class="text-center text-slate-400 mt-5 text-sm">— libre —</div>`;
          } else {
            reservas.forEach(rv => {
              const tag = document.createElement('div');
              tag.className = 'mb-1 px-2 py-1 rounded text-sm cursor-pointer hover:brightness-95';
              tag.style.background = colorFromString(rv.materia||'Materia');
              tag.textContent = `${rv.nombre||''} · ${rv.materia||''}`;
              tag.title = `Aula: ${rv.aula} · ${rv.fecha} · ${rv.franja}\nClick para borrar si conoces el PIN`;
              tag.onclick = ()=> intentarBorrar(rv);
              cell.appendChild(tag);
            });
          }
          td.appendChild(cell);
          tr.appendChild(td);
        }
        gridBody.appendChild(tr);
      }
    }

    async function intentarBorrar(rv) {
      const pin = prompt('Introduce el PIN de la reserva para borrarla');
      if (!pin) return;
      if (pin !== (rv.pin||'')) { alert('PIN incorrecto.'); return; }
      const id = idReserva(rv.aula, rv.fecha, rv.franja);
      await deleteDoc(doc(db,'reservas',id));
      renderWeek();
    }

    // ---------- Guardado ----------
    const iNombre  = document.getElementById('iNombre');
    const iMateria = document.getElementById('iMateria');
    const iPin     = document.getElementById('iPin');
    const iAula    = document.getElementById('iAula');
    const iDesde   = document.getElementById('iDesde');
    const iHasta   = document.getElementById('iHasta');
    const iFranja  = document.getElementById('iFranja');
    const msg      = document.getElementById('msg');
    const btnGuardar = document.getElementById('btnGuardar');

    // Fechas iniciales por comodidad: semana actual
    const hoy = new Date(); iDesde.value = fmtISO(hoy); iHasta.value = fmtISO(hoy);

    function idReserva(aula, fecha, franja) {
      return `${aula}__${fecha}__${franja}`;
    }

    function diasSeleccionados() {
      return [...document.querySelectorAll('.dayChk:checked')].map(x => +x.value);
    }

    btnGuardar.onclick = async () => {
      msg.textContent = '';

      const nombre  = iNombre.value.trim();
      const materia = iMateria.value.trim();
      const pin     = iPin.value.trim();
      const aula    = iAula.value;
      const desde   = new Date(iDesde.value);
      const hasta   = new Date(iHasta.value);
      const franja  = iFranja.value;
      const diasOK  = diasSeleccionados(); // 0..6

      if (!nombre || !materia || !iDesde.value || !iHasta.value) {
        alert('Completa Nombre, Materia y fechas.');
        return;
      }
      if (hasta < desde) {
        alert('La fecha "Hasta" no puede ser anterior a "Desde".');
        return;
      }

      // Itera días del rango y crea reservas en los días seleccionados (por día de la semana)
      let total = 0, conflictos = 0;
      for (let d = new Date(desde); d <= hasta; d.setDate(d.getDate()+1)) {
        const dow = d.getDay();
        if (!diasOK.includes(dow)) continue;
        const fechaISO = fmtISO(d);
        const id = idReserva(aula, fechaISO, franja);
        const ref = doc(db, 'reservas', id);
        const snap = await getDoc(ref);
        if (snap.exists()) { conflictos++; continue; }

        await setDoc(ref, {
          id, aula, fecha: fechaISO, franja,
          nombre, materia, pin
        });
        total++;
      }

      if (total>0) {
        msg.textContent = `Se guardaron ${total} reservas.${conflictos?` (${conflictos} en conflicto)`:''}`;
      } else if (conflictos>0) {
        alert('Ya existe una reserva en ese aula/franja para todas las fechas elegidas.');
      } else {
        msg.textContent = 'No había días marcados para repetir.';
      }
      renderWeek();
    };

    // Al cambiar de aula, recargo la semana (para ver las reservas de ese espacio)
    iAula.addEventListener('change', renderWeek);

    // Primera carga
    renderWeek();
  </script>
</body>
</html>
